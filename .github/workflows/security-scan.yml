name: DevSecOps Security Pipeline

on:
  workflow_call:

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      # UtilitÃ¡rios que vocÃª usa (jq/unzip/wget)
      - name: Install utils
        run: sudo apt-get update && sudo apt-get install -y jq unzip wget

      - name: Checkout target repository
        uses: actions/checkout@v4

      # ==================== GITLEAKS (Secret Detection) ====================
      - name: Run Gitleaks
        run: |
          docker run --rm -v "$(pwd):/scan" zricethezav/gitleaks:latest detect --source=/scan --report-format=json --report-path=/scan/gitleaks-report.json --verbose --no-git
        continue-on-error: true

      # ==================== Trufflehog ===================
      - name: Trufflehog
        run: docker run --rm -v "$(pwd):/repo" trufflesecurity/trufflehog:latest filesystem /repo --json > trufflehog-report.json
      
      # ==================== SEMGREP (SAST) ====================
      - name: INSTALL SEMGREP
        run: |
          python -m pip install --upgrade pip
          python -m pip install semgrep
          
      - name: semgrep/ci
        run: semgrep ci --verbose
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Show Semgrep Results (summary)
        run: |
          if [ -f semgrep-results.json ]; then
            echo "## Semgrep Results:"
            jq '.results[] | {rule_id: .check_id, message: .extra.message, file: .path}' semgrep-results.json || true
          else
            echo "No semgrep-results.json found."
          fi
        continue-on-error: true

      # ==================== DEPENDENCY CHECK ====================
      - name: Run OWASP Dependency Check
        run: |
          wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v8.4.3/dependency-check-8.4.3-release.zip
          unzip -q dependency-check-8.4.3-release.zip
          ./dependency-check/bin/dependency-check.sh \
            --project "Security Scan" \
            --scan . \
            --format JSON \
            --format HTML \
            --out ./dependency-reports \
            --prettyPrint
        continue-on-error: true

      - name: Show Dependency Check Results (summary)
        run: |
          if [ -f ./dependency-reports/dependency-check-report.json ]; then
            echo "## Dependency Check Results:"
            jq '.dependencies[]
                | select(.vulnerabilities != null)
                | {fileName: .fileName, vulnerabilities: (.vulnerabilities | length)}' \
              ./dependency-reports/dependency-check-report.json || true
          else
            echo "No dependency-check-report.json found."
          fi
        continue-on-error: true
      
      # =============== Artifacts ================== #
      - name: Upload TruffleHog report
        uses: actions/upload-artifact@v4
        with:
            name: security-reports
            path: | 
              gitleaks-report.json
              trufflehog-report.json
              semgrep-results.json


      # ==================== SIMPLE SUMMARY ====================
      - name: Generate Simple Summary
        if: always()
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ref**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Tools Executed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Gitleaks (Secret Detection)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Semgrep (Static Analysis)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… OWASP Dependency Check" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Œ See the job logs for details. (Artifacts upload not configured yet.)" >> $GITHUB_STEP_SUMMARY
