name: DevSecOps Security Pipeline
on:
  workflow_call:
      ref:
        required: false
        type: string
        default: 'main'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}

      # ==================== GITLEAKS (Secret Detection) ====================
      - name: Run Gitleaks
        run: |
          docker run --rm -v $(pwd):/scan zricethezav/gitleaks:latest detect /scan --no-git --verbose
        continue-on-error: true

      # ==================== SEMGREP (SAST) ====================
      - name: Run Semgrep
        run: |
          python -m pip install semgrep
          semgrep --config=auto --verbose --json --output=semgrep-results.json .
        continue-on-error: true

      - name: Show Semgrep Results
        run: |
          if [ -f semgrep-results.json ]; then
            echo "## Semgrep Results:"
            cat semgrep-results.json | jq '.results[] | {rule_id: .check_id, message: .extra.message, file: .path}'
          fi
        continue-on-error: true

      # ==================== DEPENDENCY CHECK ====================
      - name: Run OWASP Dependency Check
        run: |
          # Download and run Dependency Check
          wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v8.4.3/dependency-check-8.4.3-release.zip
          unzip -q dependency-check-8.4.3-release.zip
          ./dependency-check/bin/dependency-check.sh \
            --project "Security Scan" \
            --scan . \
            --format JSON \
            --format HTML \
            --out ./dependency-reports \
            --prettyPrint
        continue-on-error: true

      - name: Show Dependency Check Results
        run: |
          if [ -f ./dependency-reports/dependency-check-report.json ]; then
            echo "## Dependency Check Results:"
            cat ./dependency-reports/dependency-check-report.json | jq '.dependencies[] | select(.vulnerabilities != null) | {fileName: .fileName, vulnerabilities: (.vulnerabilities | length)}'
          fi
        continue-on-error: true


      # ==================== SIMPLE SUMMARY ====================
      - name: Generate Simple Summary
        if: always()
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: ${{ inputs.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Tools Executed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Gitleaks (Secret Detection)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Semgrep (Static Analysis)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… OWASP Dependency Check" >> $GITHUB_STEP_SUMMARY
             
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Check artifacts for detailed reports" >> $GITHUB_STEP_SUMMARY
